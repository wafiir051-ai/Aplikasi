<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neo Tetris Cyberpunk</title>
    <!-- Tailwind CSS untuk styling cepat dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome untuk ikon -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts untuk nuansa Cyberpunk -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00fff2;
            --secondary: #ff00de;
            --warning: #facc15;
            --danger: #ff2200;
            --bg-dark: #05050a;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            background-color: var(--bg-dark);
            color: #fff;
            touch-action: none; 
            height: 100dvh; 
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        /* Layar Pemuatan (Loading Screen) */
        #loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease, visibility 0.8s;
        }

        .loading-bar-container {
            width: 250px;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            margin-top: 20px;
            overflow: hidden;
        }

        .loading-bar-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary);
            animation: load-progress 3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes load-progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        /* Latar Belakang Animasi */
        #bg-canvas { position: fixed; inset: 0; z-index: -2; }
        .scanlines { position: fixed; inset: 0; background: linear-gradient(to bottom, transparent 50%, rgba(0, 0, 0, 0.1) 50%); background-size: 100% 4px; z-index: -1; pointer-events: none; opacity: 0.3; }
        .cyber-grid { position: fixed; inset: 0; background-image: linear-gradient(rgba(0, 255, 242, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 0, 222, 0.05) 1px, transparent 1px); background-size: 50px 50px; z-index: -1; animation: pulse-grid 8s ease-in-out infinite; }

        @keyframes pulse-grid { 0%, 100% { opacity: 0.2; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.05); } }

        .layout-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom) 12px;
            max-height: 100dvh;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }

        canvas#tetris {
            image-rendering: pixelated; 
            box-shadow: 0 0 40px rgba(0, 255, 242, 0.15), inset 0 0 20px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 242, 0.3);
            background: rgba(2, 2, 5, 0.95);
            max-height: 100%;
            max-width: 100%;
            border-radius: 4px;
            aspect-ratio: 12 / 20;
        }

        .btn-control {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(0, 255, 242, 0.15);
            color: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            user-select: none;
            backdrop-filter: blur(5px);
        }

        .btn-control:active { background: var(--primary); color: black; box-shadow: 0 0 15px var(--primary); transform: scale(0.95); }

        .glass-panel {
            background: rgba(10, 10, 25, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .menu-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(0, 255, 242, 0.2);
            background: rgba(0, 255, 242, 0.03);
            color: var(--primary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-radius: 4px;
            transition: all 0.3s;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
        }

        .menu-btn:hover { background: rgba(0, 255, 242, 0.1); border-color: var(--primary); }
        .mode-active { border-color: var(--secondary) !important; color: var(--secondary) !important; background: rgba(255, 0, 222, 0.05) !important; }

        .glitch-text { font-family: 'Orbitron', sans-serif; position: relative; text-shadow: 2px 0 var(--danger), -2px 0 var(--primary); }
        .hidden-transition { opacity: 0 !important; visibility: hidden !important; }

        /* Leaderboard Items */
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.85rem;
            transition: background 0.3s;
        }
    </style>
</head>
<body>

    <!-- LAYAR LOADING -->
    <div id="loading-screen">
        <div class="mb-4 text-center">
            <h2 class="text-2xl font-bold glitch-text italic mb-1 tracking-widest">NEO LINK</h2>
            <p class="text-[10px] text-cyan-400 uppercase tracking-[0.4em] animate-pulse">Menghubungkan ke Cloud...</p>
        </div>
        <div class="loading-bar-container">
            <div class="loading-bar-fill"></div>
        </div>
        <p class="mt-4 text-[9px] text-gray-500 uppercase tracking-widest font-mono" id="loading-text">Menyinkronkan Data Saraf...</p>
    </div>

    <canvas id="bg-canvas"></canvas>
    <div class="cyber-grid"></div>
    <div class="scanlines"></div>

    <!-- HALAMAN BERANDA -->
    <div id="home-page" class="fixed inset-0 z-50 flex items-center justify-center p-6 opacity-0 invisible transition-all duration-700">
        <div class="glass-panel w-full max-w-4xl p-8 rounded-lg flex flex-col md:flex-row gap-8">
            <!-- Menu Kiri -->
            <div class="flex-1 text-center">
                <div class="mb-2">
                    <span class="text-[10px] text-pink-500 tracking-[0.5em] font-bold uppercase">Sistem Override</span>
                </div>
                <h1 class="text-3xl font-bold glitch-text mb-4 italic">NEO TETRIS</h1>
                
                <div class="mb-4 text-left">
                    <label class="text-[9px] uppercase text-cyan-500 font-bold mb-1 block">Alias Hacker</label>
                    <input type="text" id="username-input" placeholder="Masukkan Nama..." maxlength="15" class="w-full bg-black/40 border border-cyan-500/30 p-2 rounded text-sm text-cyan-100 focus:outline-none focus:border-cyan-500 transition-all font-mono">
                    <p id="user-id-display" class="text-[8px] text-gray-600 mt-1 uppercase truncate"></p>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="setMode('classic')" id="mode-classic" class="menu-btn mode-active">Classic</button>
                    <button onclick="setMode('insane')" id="mode-insane" class="menu-btn">Insane</button>
                    <button onclick="setMode('speed')" id="mode-speed" class="menu-btn">Speed</button>
                    <button onclick="setMode('invisible')" id="mode-invisible" class="menu-btn">Hidden</button>
                </div>
                
                <button onclick="startGame()" class="w-full py-4 bg-cyan-500 text-black font-bold rounded uppercase tracking-[0.2em] shadow-[0_0_20px_rgba(0,255,242,0.3)] hover:brightness-110 active:scale-95 transition-all font-['Orbitron'] text-xs">
                    MULAI LINK
                </button>
            </div>

            <!-- Papan Peringkat Kanan -->
            <div class="flex-1 border-t md:border-t-0 md:border-l border-white/10 pt-4 md:pt-0 md:pl-8 overflow-hidden flex flex-col min-h-[300px]">
                <h3 class="text-xs font-bold text-pink-500 uppercase tracking-widest mb-4 flex items-center justify-between">
                    <span><i class="fas fa-trophy mr-2"></i> Papan Peringkat Global</span>
                </h3>
                <div id="leaderboard-list" class="flex-1 overflow-y-auto max-h-[400px] scrollbar-hide space-y-1">
                    <div class="text-[10px] text-gray-500 italic py-4 text-center">Memuat kedudukan pemain...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- UI GAMEPLAY -->
    <div id="game-ui" class="layout-container hidden">
        <div class="flex justify-between items-end py-4 gap-4">
            <div class="glass-panel px-4 py-2 rounded-md border-l-4 border-cyan-500">
                <span class="text-[9px] text-cyan-500 block uppercase font-bold tracking-widest">Protokol</span>
                <span id="display-mode" class="text-xs font-bold text-white uppercase">Classic</span>
            </div>
            <div class="flex-1 text-right">
                <span class="text-[9px] text-pink-500 block uppercase font-bold tracking-widest">Aliran Data</span>
                <span id="score" class="text-3xl font-bold text-white tracking-tighter tabular-nums">0</span>
            </div>
            <button onclick="quitToHome()" class="glass-panel w-10 h-10 flex items-center justify-center rounded-md text-red-500 hover:bg-red-500/10 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="game-wrapper flex-1 relative flex justify-center items-center overflow-hidden">
            <div id="combo-notif" class="absolute pointer-events-none opacity-0 transition-all font-['Orbitron'] font-bold text-3xl italic text-pink-400 z-20">COMBO</div>
            <canvas id="tetris"></canvas>
            
            <div id="gameover-overlay" class="absolute inset-0 hidden flex flex-col items-center justify-center bg-black/95 backdrop-blur-xl z-30 p-8 rounded border border-red-500/20">
                <div class="text-red-500 text-5xl mb-4"><i class="fas fa-radiation"></i></div>
                <h2 class="text-2xl font-bold text-red-500 mb-1 uppercase tracking-[0.3em] font-['Orbitron']">RALAT LINK</h2>
                <p id="saving-status" class="text-gray-500 text-[10px] mb-6 uppercase tracking-widest">Skor disimpan...</p>
                <p id="final-score" class="text-3xl text-white mb-10 font-bold tabular-nums">0</p>
                <button onclick="startGame()" class="menu-btn w-full max-w-xs !border-cyan-500 !text-cyan-500">MULAI ULANG</button>
                <button onclick="quitToHome()" class="text-gray-500 mt-6 uppercase text-[10px] tracking-widest hover:text-white transition-colors">KEMBALI KE MENU</button>
            </div>
        </div>

        <!-- Kontrol Sentuh -->
        <div class="grid grid-cols-5 gap-3 h-32 py-4 shrink-0 font-['Orbitron']">
            <button class="btn-control text-yellow-400" id="btn-rotate-ccw"><i class="fas fa-undo"></i></button>
            <div class="col-span-3 grid grid-cols-3 gap-2">
                <div></div>
                <button class="btn-control" id="btn-up"><i class="fas fa-angle-double-down"></i></button>
                <div></div>
                <button class="btn-control" id="btn-left"><i class="fas fa-chevron-left"></i></button>
                <button class="btn-control" id="btn-down"><i class="fas fa-chevron-down"></i></button>
                <button class="btn-control" id="btn-right"><i class="fas fa-chevron-right"></i></button>
            </div>
            <button class="btn-control text-pink-500" id="btn-rotate-cw"><i class="fas fa-redo"></i></button>
        </div>
    </div>

<script type="module">
    // Mengimpor fungsi Firebase menggunakan ES Modules (Vanilla JS)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Konfigurasi dari lingkungan
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'tetris-cyber-app';

    let user = null;
    let userData = { username: "Hacker-Anon", highscore: 0 };
    const usernameInput = document.getElementById('username-input');
    const leaderboardList = document.getElementById('leaderboard-list');

    // Inisialisasi Auth
    const initAuth = async () => {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }
    };

    onAuthStateChanged(auth, async (u) => {
        if (u) {
            user = u;
            document.getElementById('user-id-display').innerText = `NODE-ID: ${user.uid}`;
            
            const userDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
            const snap = await getDoc(userDoc);
            
            if (snap.exists()) {
                userData = snap.data();
                usernameInput.value = userData.username;
            } else {
                await setDoc(userDoc, { username: userData.username, highscore: 0, uid: user.uid });
                // Tambahkan ke leaderboard publik
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', user.uid), {
                    username: userData.username,
                    highscore: 0,
                    uid: user.uid,
                    updatedAt: Date.now()
                });
            }
            
            // Listener Real-time untuk SEMUA akun di Leaderboard
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            onSnapshot(q, (snapshot) => {
                const players = [];
                snapshot.forEach(doc => players.push(doc.data()));
                renderLeaderboard(players);
            });
        }
    });

    initAuth();

    function renderLeaderboard(players) {
        players.sort((a, b) => b.highscore - a.highscore);
        leaderboardList.innerHTML = players.map((p, i) => `
            <div class="leaderboard-item ${p.uid === user?.uid ? 'bg-cyan-500/10 border-l-2 border-cyan-500' : ''}">
                <div class="flex items-center gap-2 overflow-hidden">
                    <span class="font-mono text-[9px] opacity-50">${i+1}.</span>
                    <span class="font-bold truncate ${p.uid === user?.uid ? 'text-cyan-400' : 'text-white'}">${p.username}</span>
                </div>
                <span class="font-mono text-cyan-400">${p.highscore.toLocaleString()}</span>
            </div>
        `).join('');
    }

    usernameInput.addEventListener('change', async () => {
        if (!user) return;
        const name = usernameInput.value.trim().substring(0, 15) || "Hacker-Anon";
        userData.username = name;
        await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile'), { username: name });
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', user.uid), { username: name });
    });

    // --- LOGIKA PERMAINAN (JS MURNI) ---
    const canvas = document.getElementById('tetris');
    const context = canvas.getContext('2d');
    const scoreElement = document.getElementById('score');
    const homePage = document.getElementById('home-page');
    const gameUI = document.getElementById('game-ui');
    const gameoverOverlay = document.getElementById('gameover-overlay');

    const COLS = 12;
    const ROWS = 20;
    const BLOCK_SIZE = 20;
    
    canvas.width = COLS * BLOCK_SIZE;
    canvas.height = ROWS * BLOCK_SIZE;
    context.scale(BLOCK_SIZE, BLOCK_SIZE);

    const SHAPES = [
        [],
        [[0,1,0],[1,1,1],[0,0,0]], // T
        [[2,2],[2,2]],             // O
        [[0,3,3],[3,3,0],[0,0,0]], // S
        [[4,4,0],[0,4,4],[0,0,0]], // Z
        [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]], // I
        [[6,0,0],[6,6,6],[0,0,0]], // L
        [[0,0,7],[7,7,7],[0,0,0]]  // J
    ];

    const COLORS = [null, '#00fff2', '#ff00de', '#facc15', '#ff2200', '#00ff66', '#0055FF', '#BD00FF'];

    let arena = Array.from({length: ROWS}, () => new Array(COLS).fill(0));
    let player = { pos: {x: 0, y: 0}, matrix: null, score: 0 };
    let dropCounter = 0;
    let dropInterval = 1000;
    let lastTime = 0;
    let isPaused = true;
    let currentMode = 'classic';
    let animReq = null;

    window.setMode = (m) => {
        currentMode = m;
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('mode-active'));
        document.getElementById(`mode-${m}`).classList.add('mode-active');
    };

    window.startGame = () => {
        homePage.classList.add('hidden');
        gameoverOverlay.classList.add('hidden');
        gameUI.classList.remove('hidden');
        arena.forEach(row => row.fill(0));
        player.score = 0;
        playerReset();
        isPaused = false;
        lastTime = performance.now();
        update();
    };

    window.quitToHome = () => {
        isPaused = true;
        gameUI.classList.add('hidden');
        homePage.classList.remove('hidden');
        homePage.style.opacity = '1';
        homePage.style.visibility = 'visible';
    };

    function playerReset() {
        const id = (Math.random() * (SHAPES.length - 1) | 0) + 1;
        player.matrix = SHAPES[id];
        player.pos.y = 0;
        player.pos.x = (COLS / 2 | 0) - (player.matrix[0].length / 2 | 0);
        if (collide(arena, player)) gameOver();
    }

    function collide(arena, player) {
        const [m, o] = [player.matrix, player.pos];
        for (let y = 0; y < m.length; ++y) {
            for (let x = 0; x < m[y].length; ++x) {
                if (m[y][x] !== 0 && (arena[y + o.y] && arena[y + o.y][x + o.x]) !== 0) return true;
            }
        }
        return false;
    }

    function merge(arena, player) {
        player.matrix.forEach((row, y) => {
            row.forEach((val, x) => {
                if (val !== 0) arena[y + player.pos.y][x + player.pos.x] = val;
            });
        });
    }

    function arenaSweep() {
        let rowCount = 1;
        outer: for (let y = arena.length - 1; y > 0; --y) {
            for (let x = 0; x < arena[y].length; ++x) {
                if (arena[y][x] === 0) continue outer;
            }
            const row = arena.splice(y, 1)[0].fill(0);
            arena.unshift(row);
            ++y;
            player.score += rowCount * 100;
            rowCount *= 2;
        }
    }

    function draw() {
        context.fillStyle = '#05050a';
        context.fillRect(0, 0, canvas.width, canvas.height);
        drawMatrix(arena, {x: 0, y: 0});
        drawMatrix(player.matrix, player.pos);
    }

    function drawMatrix(matrix, offset) {
        matrix.forEach((row, y) => {
            row.forEach((val, x) => {
                if (val !== 0) {
                    context.fillStyle = COLORS[val];
                    context.fillRect(x + offset.x, y + offset.y, 0.9, 0.9);
                }
            });
        });
    }

    function playerDrop() {
        player.pos.y++;
        if (collide(arena, player)) {
            player.pos.y--;
            merge(arena, player);
            playerReset();
            arenaSweep();
            scoreElement.innerText = player.score;
        }
        dropCounter = 0;
    }

    function playerMove(dir) {
        player.pos.x += dir;
        if (collide(arena, player)) player.pos.x -= dir;
    }

    function playerRotate(dir) {
        const pos = player.pos.x;
        let offset = 1;
        const m = player.matrix;
        for (let y = 0; y < m.length; ++y) {
            for (let x = 0; x < y; ++x) [m[x][y], m[y][x]] = [m[y][x], m[x][y]];
        }
        dir > 0 ? m.forEach(row => row.reverse()) : m.reverse();
        while (collide(arena, player)) {
            player.pos.x += offset;
            offset = -(offset + (offset > 0 ? 1 : -1));
            if (offset > m[0].length) {
                player.pos.x = pos;
                return;
            }
        }
    }

    function gameOver() {
        isPaused = true;
        document.getElementById('final-score').innerText = player.score;
        gameoverOverlay.classList.remove('hidden');
        if (player.score > userData.highscore) {
            saveScore(player.score);
        }
    }

    async function saveScore(s) {
        if (!user) return;
        await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile'), { highscore: s });
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', user.uid), { highscore: s, updatedAt: Date.now() });
    }

    function update(time = 0) {
        if (!isPaused) {
            const dt = time - lastTime;
            lastTime = time;
            dropCounter += dt;
            if (dropCounter > dropInterval) playerDrop();
            draw();
            animReq = requestAnimationFrame(update);
        }
    }

    // Input Control
    document.getElementById('btn-left').onclick = () => playerMove(-1);
    document.getElementById('btn-right').onclick = () => playerMove(1);
    document.getElementById('btn-down').onclick = () => playerDrop();
    document.getElementById('btn-rotate-cw').onclick = () => playerRotate(1);
    document.getElementById('btn-rotate-ccw').onclick = () => playerRotate(-1);
    document.getElementById('btn-up').onclick = () => { while(!collide(arena, player)) player.pos.y++; player.pos.y--; playerDrop(); };

    window.addEventListener('load', () => {
        setTimeout(() => {
            document.getElementById('loading-screen').classList.add('hidden-transition');
            homePage.classList.remove('invisible');
            homePage.style.opacity = '1';
        }, 3000);
    });
</script>
</body>
</html>