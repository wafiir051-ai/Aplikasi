<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Neo Tetris: Final Interface</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap');

        :root {
            --primary: #00fff2;
            --secondary: #ff00de;
            --accent: #7000ff;
            --warning: #facc15;
            --danger: #ff2200;
            --bg-dark: #05050a;
            --glass: rgba(10, 10, 30, 0.7);
            --font-tech: 'Orbitron', sans-serif;
            --font-main: 'Rajdhani', sans-serif;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: none;
        }

        body {
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            overflow: hidden; 
            background-color: var(--bg-dark);
            color: #fff;
            height: 100dvh; 
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- FUTURISTIC BACKGROUND --- */
        .bg-layer {
            position: fixed; inset: 0; z-index: -1;
            background: linear-gradient(to bottom, #05050a, #0a0a20);
            overflow: hidden;
        }

        .grid-plane {
            position: absolute; width: 200%; height: 200%;
            top: -50%; left: -50%;
            background-image: 
                linear-gradient(rgba(0, 255, 242, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 242, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            transform: perspective(500px) rotateX(60deg);
            animation: grid-move 20s linear infinite;
        }

        @keyframes grid-move {
            from { background-position: 0 0; }
            to { background-position: 0 1000px; }
        }

        .neon-blur {
            position: absolute; width: 400px; height: 400px;
            border-radius: 50%; filter: blur(120px); opacity: 0.15;
            pointer-events: none;
        }

        /* --- UI WRAPPER --- */
        #loading-screen {
            position: fixed; inset: 0; background: var(--bg-dark); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .cyber-loader {
            width: 250px; height: 4px; background: rgba(255,255,255,0.05);
            position: relative; border-radius: 10px; overflow: hidden;
        }
        .cyber-loader::after {
            content: ''; position: absolute; left: 0; width: 40%; height: 100%;
            background: var(--primary); box-shadow: 0 0 20px var(--primary);
            animation: slide 1.5s infinite ease-in-out;
        }
        @keyframes slide { 0% { left: -40%; } 100% { left: 100%; } }

        /* --- HOME INTERFACE --- */
        #home-page {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; width: 100%; padding: 20px;
        }

        .main-frame {
            background: var(--glass);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(0, 255, 242, 0.3);
            border-radius: 24px;
            padding: 40px;
            width: 100%; max-width: 420px;
            text-align: center;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 20px rgba(0, 255, 242, 0.1);
        }

        .main-frame::before {
            content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
            border-radius: 26px; background: linear-gradient(45deg, var(--primary), transparent, var(--secondary));
            z-index: -1; opacity: 0.3;
        }

        .title-glitch {
            font-family: var(--font-tech); font-weight: 900; font-size: 3.5rem; margin: 0;
            letter-spacing: 5px; color: #fff; text-shadow: 3px 3px var(--secondary);
            position: relative;
        }

        input {
            width: 100%; background: rgba(0,0,0,0.6); border: 1px solid rgba(0, 255, 242, 0.5);
            padding: 16px; color: var(--primary); border-radius: 12px; margin: 30px 0;
            text-align: center; font-family: var(--font-tech); font-size: 1rem; outline: none;
            transition: 0.3s;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 255, 242, 0.3); }

        .mode-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 25px; }
        .mode-chip {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.5); padding: 12px; border-radius: 10px;
            font-family: var(--font-tech); font-size: 0.7rem; transition: 0.3s;
        }
        .mode-chip.active {
            background: rgba(0, 255, 242, 0.1); border-color: var(--primary);
            color: var(--primary); box-shadow: 0 0 15px rgba(0, 255, 242, 0.2);
        }

        .btn-action {
            width: 100%; padding: 20px; background: var(--primary); color: #000;
            border: none; border-radius: 12px; font-family: var(--font-tech); font-weight: 900;
            cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            clip-path: polygon(0 0, 90% 0, 100% 30%, 100% 100%, 10% 100%, 0 70%);
            transition: 0.3s;
        }
        .btn-action:hover { transform: translateY(-2px); filter: brightness(1.2); }
        .btn-action:active { transform: scale(0.98); }

        /* --- GAME INTERFACE --- */
        #game-ui {
            width: 100%; height: 100dvh; display: none; flex-direction: column;
            padding: 20px; gap: 15px;
        }

        .header-status { display: grid; grid-template-columns: 1.2fr 1fr 1.2fr; gap: 10px; }
        .stat-box {
            background: var(--glass); border-left: 3px solid var(--primary);
            padding: 10px; border-radius: 4px 12px 12px 4px;
        }
        .stat-label { font-size: 0.6rem; color: var(--primary); opacity: 0.7; letter-spacing: 1px; font-family: var(--font-tech); }
        .stat-value { font-size: 1.1rem; font-weight: 700; display: block; font-family: var(--font-tech); }

        .main-canvas-area {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center;
            perspective: 1000px;
        }

        canvas#tetris {
            background: rgba(0,0,0,0.8); border: 2px solid rgba(0, 255, 242, 0.2);
            border-radius: 12px; height: 90%; max-height: 550px; width: auto;
            box-shadow: 0 0 40px rgba(0, 0, 0, 1);
            transition: transform 0.1s ease-out;
        }

        .controls-grid {
            display: grid; grid-template-areas: "hL drop hR" "left down right";
            grid-template-columns: 1fr 1.2fr 1fr; gap: 12px; 
            padding-bottom: env(safe-area-inset-bottom);
        }

        .btn-joy {
            height: 55px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; color: #fff; font-size: 1.4rem; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .btn-joy:active { background: var(--primary); color: #000; border-color: #fff; }
        .btn-special { background: rgba(250, 204, 21, 0.1); border-color: var(--warning); color: var(--warning); }

        .overlay-card {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 300; backdrop-filter: blur(15px);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="bg-layer">
        <div class="grid-plane"></div>
        <div class="neon-blur" style="top: -100px; left: -100px; background: var(--accent);"></div>
        <div class="neon-blur" style="bottom: -100px; right: -100px; background: var(--secondary);"></div>
    </div>

    <div id="loading-screen">
        <h2 style="font-family: var(--font-tech); letter-spacing: 10px; margin-bottom: 20px;">LINKING...</h2>
        <div class="cyber-loader"></div>
    </div>

    <div id="home-page">
        <div class="main-frame">
            <h1 class="title-glitch">NEO-T</h1>
            <p style="font-size: 0.7rem; letter-spacing: 5px; opacity: 0.6; margin-top: 5px;">INTERFACE v2.0</p>
            
            <input type="text" id="username" placeholder="IDENTITAS OPERATOR" maxlength="12">
            
            <div class="mode-selector">
                <button class="mode-chip active" id="m-classic" onclick="setMode('classic', 'm-classic')">CLASSIC</button>
                <button class="mode-chip" id="m-insane" onclick="setMode('insane', 'm-insane')">OVERLOAD</button>
                <button class="mode-chip" id="m-speed" onclick="setMode('speed', 'm-speed')">SPEED</button>
                <button class="mode-chip" id="m-ghost" onclick="setMode('hidden', 'm-ghost')">ZEN</button>
            </div>

            <div class="leaderboard" id="leaderboard-list" style="margin-bottom: 25px; max-height: 120px; overflow-y: auto; text-align: left;">
                <!-- Data Leaderboard -->
            </div>

            <button class="btn-action" onclick="startGame()">SYNCHRONIZE</button>
        </div>
    </div>

    <div id="game-ui">
        <div class="header-status">
            <div class="stat-box">
                <span class="stat-label">OPERATOR</span>
                <span id="player-alias" class="stat-value" style="color: var(--secondary); font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis;">GUEST</span>
            </div>
            <div class="stat-box" style="border-left-color: var(--warning);">
                <span class="stat-label">LVL</span>
                <span id="level-val" class="stat-value">1</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">DATA POOL</span>
                <span id="score" class="stat-value" style="color: var(--primary);">0</span>
            </div>
        </div>

        <div class="main-canvas-area">
            <canvas id="tetris"></canvas>
            
            <div id="gameover-overlay" class="overlay-card">
                <h2 style="font-family: var(--font-tech); color: var(--danger); font-size: 2.5rem; margin: 0;">DISCONNECTED</h2>
                <p id="final-score" style="font-family: var(--font-tech); margin: 20px 0; font-size: 1.2rem;">SCORE: 0</p>
                <button class="btn-action" onclick="startGame()" style="width: 220px;">RE-SYNC</button>
                <p onclick="quitToHome()" style="margin-top: 20px; cursor: pointer; opacity: 0.4; font-size: 0.8rem; letter-spacing: 2px;">ABORT MISSION</p>
            </div>
        </div>

        <div class="controls-grid">
            <button class="btn-joy" id="ctrl-rot-ccw"><i class="fas fa-arrow-rotate-left"></i></button>
            <button class="btn-joy btn-special" id="ctrl-hard-drop"><i class="fas fa-bolt"></i></button>
            <button class="btn-joy" id="ctrl-rot-cw"><i class="fas fa-arrow-rotate-right"></i></button>
            <button class="btn-joy" id="ctrl-left"><i class="fas fa-chevron-left"></i></button>
            <button class="btn-joy" id="ctrl-down"><i class="fas fa-chevron-down"></i></button>
            <button class="btn-joy" id="ctrl-right"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Configuration
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'tetris-neo-elite-v2';

    let currentUser = null;
    let scores = [];

    // System Initialization
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else { await signInAnonymously(auth); }
        } catch (e) { console.error("Auth Fail", e); }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            setupLeaderboard();
            setTimeout(() => {
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-screen').classList.add('hidden'), 800);
            }, 1200);
        } else { initAuth(); }
    });

    function setupLeaderboard() {
        const scoresRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
        onSnapshot(scoresRef, (snap) => {
            const list = [];
            snap.forEach(d => list.push(d.data()));
            scores = list.sort((a, b) => b.score - a.score).slice(0, 5);
            renderLeaderboard();
        }, (e) => console.log("LB Offline"));
    }

    function renderLeaderboard() {
        const el = document.getElementById('leaderboard-list');
        if (!scores.length) { el.innerHTML = '<p style="opacity:0.3;font-size:0.7rem">NO GLOBAL DATA</p>'; return; }
        el.innerHTML = `<label style="color:var(--primary);font-size:0.6rem;letter-spacing:2px;display:block;margin-bottom:8px">GLOBAL TOP OPERATORS</label>` + 
        scores.map((s, i) => `
            <div style="display:flex;justify-content:space-between;font-size:0.8rem;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05)">
                <span style="opacity:0.8"><b style="color:var(--secondary)">#${i+1}</b> ${s.name}</span>
                <span style="color:var(--primary);font-weight:700">${s.score}</span>
            </div>
        `).join('');
    }

    async function saveScore(s) {
        if (!currentUser || s <= 0) return;
        const name = document.getElementById('username').value.trim() || 'OPERATOR';
        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', currentUser.uid);
        try {
            const existing = await getDoc(ref);
            if (!existing.exists() || existing.data().score < s) {
                await setDoc(ref, { name, score: s, uid: currentUser.uid, ts: Date.now() });
            }
        } catch(e) { console.warn("Save Error"); }
    }

    // --- GAME ENGINE ---
    const canvas = document.getElementById('tetris');
    const ctx = canvas.getContext('2d', { alpha: false });
    const scoreEl = document.getElementById('score');
    const levelEl = document.getElementById('level-val');
    
    const COLS = 10, ROWS = 20, SCALE = 30;
    canvas.width = COLS * SCALE;
    canvas.height = ROWS * SCALE;
    ctx.scale(SCALE, SCALE);

    const SHAPES = [
        [],
        [[0,1,0],[1,1,1],[0,0,0]], // T
        [[2,2],[2,2]],             // O
        [[0,3,3],[3,3,0],[0,0,0]], // S
        [[4,4,0],[0,4,4],[0,0,0]], // Z
        [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]], // I
        [[6,0,0],[6,6,6],[0,0,0]], // L
        [[0,0,7],[7,7,7],[0,0,0]]  // J
    ];

    // Ultra Vivid Cyberpunk Palette
    const COLORS = [
        null,
        '#00fff2', // Cyan
        '#ff00de', // Magenta
        '#facc15', // Gold
        '#ff2200', // Red
        '#00ff66', // Green
        '#7000ff', // Purple
        '#ffffff'  // White
    ];

    let arena = Array.from({length: ROWS}, () => new Array(COLS).fill(0));
    let player = { pos: {x: 0, y: 0}, matrix: null, score: 0, level: 1 };
    let isPaused = true, lastTime = 0, dropCounter = 0, dropInterval = 1000, currentMode = 'classic';

    window.setMode = (m, id) => {
        currentMode = m;
        document.querySelectorAll('.mode-chip').forEach(btn => btn.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    };

    window.startGame = () => {
        const n = document.getElementById('username').value.trim() || 'OPERATOR';
        document.getElementById('player-alias').innerText = n.toUpperCase();
        document.getElementById('home-page').classList.add('hidden');
        document.getElementById('game-ui').style.display = 'flex';
        document.getElementById('gameover-overlay').style.display = 'none';
        
        arena.forEach(r => r.fill(0));
        player.score = 0; player.level = 1;
        scoreEl.innerText = '0'; levelEl.innerText = '1';
        
        updateInterval();
        playerReset();
        isPaused = false;
        lastTime = performance.now();
        requestAnimationFrame(update);
    };

    function updateInterval() {
        if (currentMode === 'insane') dropInterval = 140;
        else if (currentMode === 'speed') dropInterval = 400;
        else dropInterval = 1000;
    }

    window.quitToHome = () => {
        isPaused = true;
        document.getElementById('game-ui').style.display = 'none';
        document.getElementById('home-page').classList.remove('hidden');
    };

    function playerReset() {
        const id = (Math.random() * (SHAPES.length - 1) | 0) + 1;
        player.matrix = SHAPES[id].map(r => [...r]);
        player.pos.y = 0;
        player.pos.x = (COLS / 2 | 0) - (player.matrix[0].length / 2 | 0);
        if (collide(arena, player)) {
            gameOver();
        }
    }

    function gameOver() {
        isPaused = true;
        document.getElementById('final-score').innerText = `SCORE: ${player.score}`;
        document.getElementById('gameover-overlay').style.display = 'flex';
        saveScore(player.score);
    }

    function collide(a, p) {
        const [m, o] = [p.matrix, p.pos];
        for (let y = 0; y < m.length; ++y) {
            for (let x = 0; x < m[y].length; ++x) {
                if (m[y][x] !== 0 && (a[y + o.y] && a[y + o.y][x + o.x]) !== 0) return true;
            }
        }
        return false;
    }

    function merge(a, p) {
        p.matrix.forEach((r, y) => r.forEach((v, x) => {
            if (v !== 0) a[y + p.pos.y][x + p.pos.x] = v;
        }));
        // Visual shake effect
        canvas.style.transform = 'translateY(5px)';
        setTimeout(() => canvas.style.transform = 'translateY(0)', 50);
    }

    function arenaSweep() {
        let count = 0;
        outer: for (let y = arena.length - 1; y >= 0; --y) {
            for (let x = 0; x < arena[y].length; ++x) { if (arena[y][x] === 0) continue outer; }
            const row = arena.splice(y, 1)[0].fill(0);
            arena.unshift(row);
            ++y; count++;
        }
        if (count > 0) {
            player.score += [0, 10, 40, 100, 300][count] * player.level;
            scoreEl.innerText = player.score;
            const nextLvl = Math.floor(player.score / 400) + 1;
            if (nextLvl > player.level) {
                player.level = nextLvl;
                levelEl.innerText = player.level;
                if (currentMode === 'classic') dropInterval = Math.max(100, 1000 - (player.level * 100));
            }
        }
    }

    function getGhostPos() {
        let gy = player.pos.y;
        while (!collide(arena, { pos: { x: player.pos.x, y: gy + 1 }, matrix: player.matrix })) gy++;
        return gy;
    }

    function draw() {
        // High-end rendering
        ctx.fillStyle = '#05050a';
        ctx.fillRect(0, 0, COLS, ROWS);
        
        // Draw Scanning Lines
        ctx.strokeStyle = 'rgba(0, 255, 242, 0.03)';
        ctx.lineWidth = 0.02;
        for(let i=0; i<ROWS; i++) {
            ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(COLS, i); ctx.stroke();
        }

        // Draw Arena
        const alphaArena = currentMode === 'hidden' ? 0.05 : 1;
        arena.forEach((r, y) => r.forEach((v, x) => {
            if(v !== 0) {
                ctx.globalAlpha = alphaArena;
                drawBlock(x, y, COLORS[v]);
            }
        }));

        // Draw Ghost (The Future Guide)
        if (!isPaused && player.matrix) {
            const gy = getGhostPos();
            ctx.globalAlpha = 0.12;
            player.matrix.forEach((r, y) => r.forEach((v, x) => {
                if (v !== 0) drawBlock(x + player.pos.x, y + gy, COLORS[v], true);
            }));
        }

        // Draw Player
        ctx.globalAlpha = 1;
        if (player.matrix) {
            player.matrix.forEach((r, y) => r.forEach((v, x) => {
                if (v !== 0) drawBlock(x + player.pos.x, y + player.pos.y, COLORS[v]);
            }));
        }
    }

    function drawBlock(x, y, color, isGhost = false) {
        ctx.shadowBlur = isGhost ? 0 : 15;
        ctx.shadowColor = color;
        ctx.fillStyle = color;
        
        // Rounded corners for blocks
        const r = 0.15;
        ctx.beginPath();
        ctx.roundRect(x + 0.05, y + 0.05, 0.9, 0.9, r);
        ctx.fill();
        
        if (!isGhost) {
            // Interior Glow
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.fillRect(x + 0.15, y + 0.15, 0.2, 0.2);
            // Border Highlight
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 0.05;
            ctx.strokeRect(x + 0.05, y + 0.05, 0.9, 0.9);
        }
        ctx.shadowBlur = 0;
    }

    function update(time = 0) {
        if (isPaused) return;
        const dt = time - lastTime;
        lastTime = time;
        dropCounter += dt;
        if (dropCounter > dropInterval) playerDrop();
        draw();
        requestAnimationFrame(update);
    }

    function playerDrop() {
        player.pos.y++;
        if (collide(arena, player)) {
            player.pos.y--;
            merge(arena, player);
            playerReset();
            arenaSweep();
        }
        dropCounter = 0;
    }

    function playerMove(d) {
        player.pos.x += d;
        if (collide(arena, player)) player.pos.x -= d;
    }

    function playerRotate(d) {
        const pos = player.pos.x;
        let offset = 1;
        rotateM(player.matrix, d);
        while (collide(arena, player)) {
            player.pos.x += offset;
            offset = -(offset + (offset > 0 ? 1 : -1));
            if (Math.abs(offset) > player.matrix[0].length) {
                rotateM(player.matrix, -d);
                player.pos.x = pos;
                return;
            }
        }
    }

    function rotateM(m, d) {
        for (let y = 0; y < m.length; ++y) {
            for (let x = 0; x < y; ++x) { [m[x][y], m[y][x]] = [m[y][x], m[x][y]]; }
        }
        if (d > 0) m.forEach(r => r.reverse());
        else m.reverse();
    }

    function hardDrop() {
        const gy = getGhostPos();
        player.pos.y = gy;
        merge(arena, player);
        playerReset();
        arenaSweep();
    }

    // High performance input handling
    const bindBtn = (id, fn) => {
        const el = document.getElementById(id);
        el.addEventListener('touchstart', (e) => { 
            e.preventDefault(); 
            if(!isPaused) { fn(); draw(); }
        }, {passive: false});
        el.addEventListener('mousedown', (e) => { 
            if(!isPaused) { fn(); draw(); }
        });
    };

    bindBtn('ctrl-left', () => playerMove(-1));
    bindBtn('ctrl-right', () => playerMove(1));
    bindBtn('ctrl-down', () => playerDrop());
    bindBtn('ctrl-rot-cw', () => playerRotate(1));
    bindBtn('ctrl-rot-ccw', () => playerRotate(-1));
    bindBtn('ctrl-hard-drop', () => hardDrop());

    document.addEventListener('keydown', e => {
        if (isPaused) return;
        switch(e.keyCode) {
            case 37: playerMove(-1); break;
            case 39: playerMove(1); break;
            case 40: playerDrop(); break;
            case 38: playerRotate(1); break;
            case 32: hardDrop(); break;
        }
        draw();
    });

</script>
</body>
</html>